# render.yaml - Chat Companion API Configuration
# Push-based AI Companion - Daily check-ins via Telegram/WhatsApp/Web

services:
  # Chat Companion API - FastAPI Backend
  - type: web
    name: companion-api
    runtime: python
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: cd src && uvicorn app.main:app --host 0.0.0.0 --port $PORT
    rootDir: api/api
    envVars:
      # Supabase Configuration
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: SUPABASE_JWT_SECRET
        sync: false
      - key: SUPABASE_JWT_AUD
        value: authenticated
      # Database
      - key: DATABASE_URL
        sync: false
      # CORS - Frontend origins (comma-separated)
      - key: CORS_ORIGINS
        sync: false
      # LLM Providers
      - key: OPENAI_API_KEY
        sync: false
      - key: GOOGLE_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      # Telegram Bot
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_WEBHOOK_SECRET
        sync: false
      # Weather API
      - key: OPENWEATHER_API_KEY
        sync: false
      # Email (Resend)
      - key: RESEND_API_KEY
        sync: false
      - key: RESEND_FROM_EMAIL
        sync: false
      # Web App URL (for email links)
      - key: WEB_APP_URL
        sync: false
      # LemonSqueezy
      - key: LEMONSQUEEZY_API_KEY
        sync: false
      - key: LEMONSQUEEZY_STORE_ID
        sync: false
      - key: LEMONSQUEEZY_VARIANT_ID
        sync: false
      - key: LEMONSQUEEZY_WEBHOOK_SECRET
        sync: false

  # Message Scheduler - Cron job for daily messages
  - type: cron
    name: message-scheduler
    runtime: python
    schedule: "* * * * *"  # Every minute
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: cd src && python -m app.jobs.scheduler
    rootDir: api/api
    envVars:
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: GOOGLE_API_KEY
        sync: false
      - key: OPENWEATHER_API_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: RESEND_FROM_EMAIL
        sync: false
      - key: WEB_APP_URL
        sync: false

  # Pattern Computation - Daily behavior pattern analysis
  - type: cron
    name: pattern-computation
    runtime: python
    schedule: "0 2 * * *"  # Daily at 2am UTC
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: cd src && python -m app.jobs.patterns
    rootDir: api/api
    envVars:
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false
      - key: GOOGLE_API_KEY
        sync: false
